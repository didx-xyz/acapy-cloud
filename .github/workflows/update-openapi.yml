name: Update OpenAPI

on:
  workflow_call:
    inputs:
      image-version:
        description: Image version to run
        required: true
        type: string
      pr-number:
        description: Pull request number (if triggered by a PR)
        required: false
        type: number

permissions: {}

jobs:
  diff:
    name: Diff
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    services:
      tenant-admin:
        image: ghcr.io/didx-xyz/acapy-cloud/app:${{ inputs.image-version }}
        ports:
          - 8080:8000
        env:
          OPENAPI_NAME: CloudAPI Multitenant Admin
          ROLE: tenant-admin
          ROOT_PATH: /tenant-admin
      tenant:
        image: ghcr.io/didx-xyz/acapy-cloud/app:${{ inputs.image-version }}
        ports:
          - 8181:8000
        env:
          OPENAPI_NAME: CloudAPI Tenant
          ROLE: tenant
          ROOT_PATH: /tenant

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Check if services are up
        run: |
          for i in {1..10}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/tenant-admin/openapi.json; then
              echo "Tenant Admin service is up"
              break
            fi
            sleep 5
          done

          for i in {1..10}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8181/tenant/openapi.json; then
              echo "Tenant service is up"
              break
            fi
            sleep 5
          done

      - name: Download OpenAPI Specs
        run: |
          mkdir -p ./tmp

          curl -s http://localhost:8080/tenant-admin/openapi.json | jq . > ./tmp/tenant-admin-openapi.json
          curl -s http://localhost:8080/tenant-admin/openapi.yaml | yq . > ./tmp/tenant-admin-openapi.yaml

          curl -s http://localhost:8181/tenant/openapi.json | jq . > ./tmp/tenant-openapi.json
          curl -s http://localhost:8181/tenant/openapi.yaml | yq . > ./tmp/tenant-openapi.yaml

      - name: Debug
        run: |
          ls -la ./tmp
          ls -la ./docs/openapi

      - name: Running OpenAPI Spec diff action (Tenant Admin JSON)
        uses: oasdiff/oasdiff-action/diff@d68e4d01cb0ba24b6811df1e190f2a640169ea6d # main
        id: tenant-admin-json
        with:
          base: ./docs/openapi/tenant-admin-openapi.json
          revision: ./tmp/tenant-admin-openapi.json
          format: markdown
          include-path-params: true

      - name: Running OpenAPI Spec diff action (Tenant Admin YAML)
        uses: oasdiff/oasdiff-action/diff@d68e4d01cb0ba24b6811df1e190f2a640169ea6d # main
        id: tenant-admin-yaml
        with:
          base: ./docs/openapi/tenant-admin-openapi.yaml
          revision: ./tmp/tenant-admin-openapi.yaml
          format: markdown
          include-path-params: true

      - name: Running OpenAPI Spec diff action (Tenant JSON)
        uses: oasdiff/oasdiff-action/diff@d68e4d01cb0ba24b6811df1e190f2a640169ea6d # main
        id: tenant-json
        with:
          base: ./docs/openapi/tenant-openapi.json
          revision: ./tmp/tenant-openapi.json
          format: markdown
          include-path-params: true

      - name: Running OpenAPI Spec diff action (Tenant YAML)
        uses: oasdiff/oasdiff-action/diff@d68e4d01cb0ba24b6811df1e190f2a640169ea6d # main
        id: tenant-yaml
        with:
          base: ./docs/openapi/tenant-openapi.yaml
          revision: ./tmp/tenant-openapi.yaml
          format: markdown
          include-path-params: true

      - name: Create OpenAPI diff PR review
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        if: inputs.pr-number != ''
        with:
          script: |
            const tenantAdminJsonDiff = `${{ steps.tenant-admin-json.outputs.diff }}`;
            const tenantAdminYamlDiff = `${{ steps.tenant-admin-yaml.outputs.diff }}`;
            const tenantJsonDiff = `${{ steps.tenant-json.outputs.diff }}`;
            const tenantYamlDiff = `${{ steps.tenant-yaml.outputs.diff }}`;

            // Unique identifier for our bot's comments
            const BOT_COMMENT_IDENTIFIER = "<!-- openapi-diff-check -->";

            // Map for spec information
            const specChanges = [
              {
                name: 'Tenant Admin API (JSON)',
                path: 'docs/openapi/tenant-admin-openapi.json',
                diff: tenantAdminJsonDiff,
                hasChanges: tenantAdminJsonDiff !== 'No changes'
              },
              {
                name: 'Tenant Admin API (YAML)',
                path: 'docs/openapi/tenant-admin-openapi.yaml',
                diff: tenantAdminYamlDiff,
                hasChanges: tenantAdminYamlDiff !== 'No changes'
              },
              {
                name: 'Tenant API (JSON)',
                path: 'docs/openapi/tenant-openapi.json',
                diff: tenantJsonDiff,
                hasChanges: tenantJsonDiff !== 'No changes'
              },
              {
                name: 'Tenant API (YAML)',
                path: 'docs/openapi/tenant-openapi.yaml',
                diff: tenantYamlDiff,
                hasChanges: tenantYamlDiff !== 'No changes'
              }
            ];

            const hasAnyChanges = specChanges.some(spec => spec.hasChanges);

            // Always create a step summary
            const fs = require('fs');
            let summaryContent = '## OpenAPI Specification Changes\n\n';

            specChanges.forEach(spec => {
              if (spec.hasChanges) {
                summaryContent += `### ${spec.name}\n\n${spec.diff}\n\n`;
              }
            });

            if (!hasAnyChanges) {
              summaryContent += 'No changes detected in any OpenAPI specification.\n';
            }

            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summaryContent);
            console.log('Added OpenAPI diff results to the step summary');

            // Get PR number
            const prNumber = parseInt('${{ inputs.pr-number }}', 10);

            // List existing comments on the PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            // Find our bot's existing comment if it exists
            const botComment = comments.data.find(comment =>
              comment.body.includes(BOT_COMMENT_IDENTIFIER)
            );

            // Create comment body
            let commentBody = `${BOT_COMMENT_IDENTIFIER}\n## OpenAPI Specification Changes\n\n`;

            // Track if any specs still have changes
            let specsWithChanges = [];
            let specsNowResolved = [];

            specChanges.forEach(spec => {
              if (spec.hasChanges) {
                specsWithChanges.push(spec);
                commentBody += `### ${spec.name}\n\n${spec.diff}\n\n`;
              } else {
                specsNowResolved.push(spec.name);
              }
            });

            // Add section about resolved specs if there were any
            if (specsNowResolved.length > 0 && botComment) {
              commentBody += `### ðŸŽ‰ Resolved Changes\n\nThese specs no longer have differences:\n\n`;
              specsNowResolved.forEach(name => {
                commentBody += `- âœ… ${name}\n`;
              });
              commentBody += `\n`;
            }

            // Add a notice if all specs are now in sync
            if (specsWithChanges.length === 0) {
              if (botComment) {
                commentBody = `${BOT_COMMENT_IDENTIFIER}\n## âœ… All OpenAPI Specifications are in sync\n\nPrevious differences have been resolved. You can now close this PR or continue with other changes.`;
              } else {
                // No previous comment and no changes - no need to comment
                console.log('No OpenAPI spec changes detected and no previous comment exists. No comment needed.');
                return;
              }
            }

            // Either update the existing comment or create a new one
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing OpenAPI diff comment on PR');
            } else if (specsWithChanges.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log(`Created OpenAPI diff comment on PR #${prNumber}`);
            }
