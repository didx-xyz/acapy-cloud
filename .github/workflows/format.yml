name: Lint / Format

on:
  workflow_call:
    inputs:
      mise-version:
        required: true
        type: string

permissions: {}

jobs:
  format:
    name: Format
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Overwrite .mise.toml # The full `mise.toml` isn't needed for this workflow
        run: |
          cat <<EOF > .mise.toml
          [tools]
          python = "3.12"
          "pipx:ruff" = "0.13.2"
          "pipx:mypy" = "1.16.1"
          EOF

      - name: Set up Mise
        uses: jdx/mise-action@e3d7b8d67a7958d1207f6ed871e83b1ea780e7b0 # v3.3.1
        with:
          version: ${{ inputs.mise-version }}
          cache: true
          experimental: true
          install: true

      - name: Check code style with Ruff
        run: ruff format --check

      - name: Check Tiltfiles with Ruff
        run: |
          find . -type f -name "Tiltfile" | while read -r file; do
            ruff format --check "$file"
          done

      - name: Check code lint rules with Ruff
        run: ruff check

      - name: Check code with mypy
        run: mypy . --ignore-missing-imports --check-untyped-defs --install-types --non-interactive
