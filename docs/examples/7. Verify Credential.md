# 7: Verify Issued Credential

## Sending proof request

Once the connection is established, the Verifier can send a proof request.

> There are optional restrictions and additional fields that can be added to the proof request, which are beyond the
> scope of this simple example. For more information, please see the
> [Aries RFC for proof presentations](https://github.com/hyperledger/aries-rfcs/tree/main/features/0037-present-proof).

```bash
curl -X 'POST' \
  'http://localhost:8300/v1/verifier/send-request' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "protocol_version": "v1",  # or v2
  "comment": "Demo",
  "type": "indy",
  "indy_proof_request": {
       "requested_attributes": {
           "surname": { "name": "Surname", "restrictions":[]},
           "name": { "name": "Name", "restrictions": []},
           "age": { "name": "Age", "restrictions": []}
        },
       "requested_predicates": {}
  },
  "connection_id": "5ef9f4e0-9f98-4e43-aef7-de11da2ccd40"
}'
```

Response:

```json
{
  "connection_id": "5ef9f4e0-9f98-4e43-aef7-de11da2ccd40",
  "created_at": "2023-11-22T10:12:20.755226Z",
  "error_msg": null,
  "parent_thread_id": "ce5b5597-d3fa-437b-a857-0927694cc4b9",
  "presentation": null,
  "presentation_request": {
    "name": null,
    "non_revoked": null,
    "nonce": "1040329690360437135931695",
    "requested_attributes": {
      "surname": {
        "name": "Surname",
        "names": null,
        "non_revoked": null,
        "restrictions": []
      },
      "name": {
        "name": "Name",
        "names": null,
        "non_revoked": null,
        "restrictions": []
      },
      "age": {
        "name": "Age",
        "names": null,
        "non_revoked": null,
        "restrictions": []
      }
    },
    "requested_predicates": {},
    "version": null
  },
  "proof_id": "v1-57c1bf16-1fc3-4506-b672-8b11580c4920",
  "protocol_version": "v1",
  "role": "verifier",
  "state": "request-sent",
  "thread_id": "ce5b5597-d3fa-437b-a857-0927694cc4b9",
  "updated_at": "2023-11-22T10:12:20.755226Z",
  "verified": null
}
```

> Note that the verifier will now have what's called a _presentation exchange record_ in state: request-sent. _Pending_
> presentation records can be viewed by calling `GET /v1/verifier/proofs`, and _completed_ presentation exchange records
> are deleted by default, but can be preserved by adding an optional `save_exchange_record=True` field to the request.

## Holder responds to proof request

The holder would have received a webhook event on topic `proofs`, indicating they have received a request. Example webhook:

```json
{
  "wallet_id": "4e0c70fb-f2ad-4f59-81f3-93d8df9b977a",
  "topic": "proofs",
  "origin": "multitenant",
  "payload": {
    "connection_id": "ab1cc0fe-d797-429c-be36-7830a79d52a1",
    "created_at": "2023-11-16T09:59:19.612647Z",
    "error_msg": null,
    "parent_thread_id": null,
    "presentation": null,
    "presentation_request": null,
    "proof_id": "v1-ba39fb0f-4dff-4bce-8db0-fdad3432cc7d",
    "protocol_version": "v1",
    "role": "prover",
    "state": "request-received",
    "thread_id": "aea706fd-5492-4ed7-ab1c-1bb9ff309926",
    "updated_at": "2023-11-16T09:59:19.612647Z",
    "verified": null
  }
}
```

The Holder will now see a presentation exchange record when they call `GET` on the `/v1/verifier/proofs` endpoint:

```bash
curl -X 'GET' \
  'http://localhost:8300/v1/verifier/proofs' \
  -H 'accept: application/json'
  -H 'x-api-key: tenant.<holder token>' \
```

Response:

```json
[
  {
    "connection_id": "ab1cc0fe-d797-429c-be36-7830a79d52a1",
    "created_at": "2023-11-16T09:59:19.612647Z",
    "error_msg": null,
    "parent_thread_id": "aea706fd-5492-4ed7-ab1c-1bb9ff309926",
    "presentation": null,
    "presentation_request": {
      "name": "Proof Request",
      "non_revoked": null,
      "nonce": "234234",
      "requested_attributes": {
        "holder surname": {
          "name": "surname",
          "names": null,
          "non_revoked": null,
          "restrictions": []
        },
        "holder name": {
          "name": "name",
          "names": null,
          "non_revoked": null,
          "restrictions": []
        },
        "holder age": {
          "name": "age",
          "names": null,
          "non_revoked": null,
          "restrictions": []
        }
      },
      "requested_predicates": {},
      "version": "1.0"
    },
    "proof_id": "v1-ba39fb0f-4dff-4bce-8db0-fdad3432cc7d",
    "protocol_version": "v1",
    "role": "prover",
    "state": "request-received",
    "thread_id": "aea706fd-5492-4ed7-ab1c-1bb9ff309926",
    "updated_at": "2023-11-16T09:59:19.612647Z",
    "verified": null
  }
]
```

Note that their role indicates `prover`, and the state is `request-received`. Prover is the term used for a holder in a
proof exchange. Additionally, note that the prover and the verifier have different `proof_id` references for the same
proof interaction.

The Holder/Prover can now check which credentials match the fields that are requested in the proof request by using the
`proof_id` and making a call to `/v1/verifier/proofs/{proof_id}/credentials`.

> NOTE: If the call is successful, but returns an empty list `[]`, it means that the credentials of the `Holder` do not
> match the requested fields in the proof request.

```bash
curl -X 'GET' \
  'http://localhost:8300/v1/verifier/proofs/v1-93e29a31-5eab-4091-9d1d-f27220f445fd/credentials' \
  -H 'accept: application/json'
```

Response:

> NOTE: This response is a list. Each object in this list corresponds to a credential, matching the requested attributes.
> In this case, the response has only one object, meaning all the requested attributes are found in one credential.

```json
[
  {
    "cred_info": {
      "attrs": {
        "Age": "25",
        "Surname": "Holder",
        "Name": "Alice"
      },
      "cred_def_id": "2hPti9M3aQqsRCy8N6jrDB:3:CL:10:Demo Person",
      "cred_rev_id": null,
      "referent": "10e6b03f-2b60-431a-9634-731594423120",
      "rev_reg_id": null,
      "schema_id": "QpSW24YVf61A3sAWxArfF6:2:Person:0.1.0"
    },
    "interval": null,
    "presentation_referents": ["name", "age", "surname"]
  }
]
```

We can now use the `referent` (the referent is the holder's reference to their credential id) from the response above to
accept the proof request:

```bash
curl -X 'POST' \
  'http://localhost:8300/v1/verifier/accept-request' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "proof_id": "v1-614a1035-c855-417d-8a8e-0c824bb6ab0f",
  "type": "indy",
  "indy_presentation_spec": {
    "requested_attributes": {
      "holder surname": {
        "cred_id": "10e6b03f-2b60-431a-9634-731594423120",
        "revealed": true
      },
      "holder name": {
        "cred_id": "10e6b03f-2b60-431a-9634-731594423120",
        "revealed": true
      },
      "holder age": {
        "cred_id": "10e6b03f-2b60-431a-9634-731594423120",
        "revealed": true
      }
    },
    "requested_predicates": {},
    "self_attested_attributes": {},
  },
  "dif_presentation_spec": {}
}'
```

<details>
<summary>Click to see Response</summary>

```json
{
  "connection_id": "43264326-57a7-4ef4-aa65-906dd9c15961",
  "created_at": "2023-11-22T06:11:46.956062Z",
  "error_msg": null,
  "parent_thread_id": "13a9375e-c124-445d-9242-d77ee54cf47f",
  "presentation": {
    "identifiers": [
      {
        "cred_def_id": "2hPti9M3aQqsRCy8N6jrDB:3:CL:10:Demo Person",
        "rev_reg_id": null,
        "schema_id": "QpSW24YVf61A3sAWxArfF6:2:Person:0.1.0",
        "timestamp": null
      }
    ],
    "proof": {
      "aggregated_proof": {
        "c_hash": "3219322627487542487718476352817657516298296911958347169452423884069641575597",
        "c_list": [
          [2,221,130,248,96,145,3,19,86,111,75,202,101,190,166,101,222,83,181,133,88,134,...]
        ]
      },
      "proofs": [
        {
          "non_revoc_proof": null,
          "primary_proof": {
            "eq_proof": {
              "a_prime": "92597261364394573165798933206533873274818813554675314388834609214520451243506734698448...",
              "e": "13957611453314484376536548594867291175484947973045451726862617289480834912062823268784462725...",
              "m": {
                "master_secret": "113138788366524810935384910670667169176189186849867816774981002913273272990310..."
              },
              "m2": "9527966448141582634179217567781606687146704440935821032302777460114542256740868407661366941...",
              "revealed_attrs": {
                "age": "25",
                "name": "27034640024117331033063128044004318218486816931520886405535659934417438781507",
                "surname": "108415864455171922802944099373800995974825385451497756533671241088029831060565"
              },
              "v": "13310269669535827858183383537992882823597862340798892194315939604086055386082234517559247559..."
            },
            "ge_proofs": []
          }
        }
      ]
    },
    "requested_proof": {
      "predicates": {},
      "revealed_attr_groups": null,
      "revealed_attrs": {
        "holder surname": {
          "encoded": "108415864455171922802944099373800995974825385451497756533671241088029831060565",
          "raw": "Holder",
          "sub_proof_index": 0
        },
        "holder name": {
          "encoded": "27034640024117331033063128044004318218486816931520886405535659934417438781507",
          "raw": "Alice",
          "sub_proof_index": 0
        },
        "holder age": {
          "encoded": "25",
          "raw": "25",
          "sub_proof_index": 0
        }
      },
      "self_attested_attrs": {},
      "unrevealed_attrs": {}
    }
  },
  "presentation_request": {
    "name": "Proof Request",
    "non_revoked": null,
    "nonce": "234234",
    "requested_attributes": {
      "holder surname": {
        "name": "surname",
        "names": null,
        "non_revoked": null,
        "restrictions": []
      },
      "holder name": {
        "name": "name",
        "names": null,
        "non_revoked": null,
        "restrictions": []
      },
      "holder age": {
        "name": "age",
        "names": null,
        "non_revoked": null,
        "restrictions": []
      }
    },
    "requested_predicates": {},
    "version": "1.0"
  },
  "proof_id": "v1-614a1035-c855-417d-8a8e-0c824bb6ab0f",
  "protocol_version": "v1",
  "role": "prover",
  "state": "presentation-sent",
  "thread_id": "13a9375e-c124-445d-9242-d77ee54cf47f",
  "updated_at": "2023-11-22T06:28:01.553809Z",
  "verified": null
}
```

</details>

If the proof request is valid, then the verification will complete automatically. Once again, we wait for the exchange
to be completed by listening to webhooks. Here is an example webhook event for the topic `proofs` in the `done` state.

```json
{
  "wallet_id": "92893658-fe2d-4f2d-8268-a60a601945a9",
  "topic": "proofs",
  "origin": "multitenant",
  "payload": {
    "connection_id": "5ef9f4e0-9f98-4e43-aef7-de11da2ccd40",
    "created_at": "2023-11-22T06:11:46.897536Z",
    "error_msg": null,
    "parent_thread_id": null,
    "presentation": null,
    "presentation_request": null,
    "proof_id": "v1-e83d3d75-9eb1-4d54-a321-7d0d5c5d286e",
    "protocol_version": "v1",
    "role": "verifier",
    "state": "done",
    "thread_id": "13a9375e-c124-445d-9242-d77ee54cf47f",
    "updated_at": "2023-11-22T06:28:01.704464Z",
    "verified": true
  }
}
```

Verifier can get the proof with all its data by making the following call:

```bash
curl -X 'GET' \
  'http://localhost:8300/v1/verifier/proofs' \
  -H 'accept: application/json'
```

<details>
<summary> Click to see Response </summary>

```json
[
  {
    "connection_id": "5ef9f4e0-9f98-4e43-aef7-de11da2ccd40",
    "created_at": "2023-11-22T06:11:46.897536Z",
    "error_msg": null,
    "parent_thread_id": "13a9375e-c124-445d-9242-d77ee54cf47f",
    "presentation": {
      "identifiers": [
        {
          "cred_def_id": "2hPti9M3aQqsRCy8N6jrDB:3:CL:10:Demo Person",
          "rev_reg_id": null,
          "schema_id": "QpSW24YVf61A3sAWxArfF6:2:Person:0.1.0",
          "timestamp": null
        }
      ],
      "proof": {
        "aggregated_proof": {
          "c_hash": "3219322627487542487718476352817657516298296911958347169452423884069641575597",
          "c_list": [
            [2,221,130,248,96,145,3,19,86,111,75,202,101,190,166,101,222,83,181,133,88,134,152,205,154,157,...]
          ]
        },
        "proofs": [
          {
            "non_revoc_proof": null,
            "primary_proof": {
              "eq_proof": {
                "a_prime": "9259726136439457316579893320653387327481881355467531438883460921452045124350673469620...",
                "e": "1395761145331448437653654859486729117548494797304545172686261728948083491206282326878446272...",
                "m": {
                  "master_secret": "11313878836652481093538491067066716917618918684986781677498100291327327294712..."
                },
                "m2": "952796644814158263417921756778160668714670444093582103230277746011454225674086840766136694...",
                "revealed_attrs": {
                  "age": "25",
                  "name": "27034640024117331033063128044004318218486816931520886405535659934417438781507",
                  "surname": "108415864455171922802944099373800995974825385451497756533671241088029831060565"
                },
                "v": "1331026966953582785818338353799288282359786234079889219431593960408605538608223451755924755..."
              },
              "ge_proofs": []
            }
          }
        ]
      },
      "requested_proof": {
        "predicates": {},
        "revealed_attr_groups": null,
        "revealed_attrs": {
          "holder surname": {
            "encoded": "108415864455171922802944099373800995974825385451497756533671241088029831060565",
            "raw": "Holder",
            "sub_proof_index": 0
          },
          "holder name": {
            "encoded": "27034640024117331033063128044004318218486816931520886405535659934417438781507",
            "raw": "Alice",
            "sub_proof_index": 0
          },
          "holder age": {
            "encoded": "25",
            "raw": "25",
            "sub_proof_index": 0
          }
        },
        "self_attested_attrs": {},
        "unrevealed_attrs": {}
      }
    },
    "presentation_request": {
      "name": "Proof Request",
      "non_revoked": null,
      "nonce": "234234",
      "requested_attributes": {
        "holder surname": {
          "name": "surname",
          "names": null,
          "non_revoked": null,
          "restrictions": []
        },
        "holder name": {
          "name": "name",
          "names": null,
          "non_revoked": null,
          "restrictions": []
        },
        "holder age": {
          "name": "age",
          "names": null,
          "non_revoked": null,
          "restrictions": []
        }
      },
      "requested_predicates": {},
      "version": "1.0"
    },
    "proof_id": "v1-e83d3d75-9eb1-4d54-a321-7d0d5c5d286e",
    "protocol_version": "v1",
    "role": "verifier",
    "state": "done",
    "thread_id": "13a9375e-c124-445d-9242-d77ee54cf47f",
    "updated_at": "2023-11-22T06:28:01.704464Z",
    "verified": true
  }
]
```

</details>

Hooray! 🥳🎉 Well done, you now know how to issue and verify credentials!

## Verifying revoked credentials

In order to make sure a credential is not revoked, when doing a proof request, it is important to add the `non_revoked`
field. This field defines a time frame where a verifier wants a credential to be valid i.e. not revoked.

To define this time frame, the `non_revoked` field has two subfields `from` (optional) and `to`, both accepting the date
in seconds since the Unix epoch. In most cases, the current time should be used, as the verifier should be interested in
credentials that are valid at the time of sending the proof request. Unless, of course, the verifier's use case requires
some specific time.

The `non-revoked` field can be passed as an empty object (`"non-revoked":{}`), then the application will use the current
time when sending the proof request.

The `non-revoked` field can be specified for for all requested attributes (global):

```json
...
"indy_proof_request": {
    "non_revoked": {
      "from": 0,
      "to": 1714727880
    },
    "requested_attributes": {
...
```

or it can be added to specific attributes:

```json
...
"indy_proof_request": {
  "requested_attributes": {
    "surname": { "name": "Surname", "non_revoked":{"to":1714727880}},
...
```

When both are specified at the same time, the attribute specific one will take priority:

```json
...
"indy_proof_request": {
  "non_revoked":{"to":1714727999},
    "requested_attributes": {
      "surname": { "name": "Surname", "non_revoked":{"to":1714727880}},
      "name": {"name": "Name"}
...
```

> In the above snippet `Surname` will be checked against the `"non_revoked":{"to":1714727880}` value, while `Name` will
> be checked against the global value `"non_revoked":{"to":1714727999}`

### Verifying with date before revoked date

When specifying a `non_revoked` time frame that comes before the revoked date, the proof request will pass. This is by
design as the credential was valid in that time frame.

Let's demonstrate:

Listing holder's credentials:

```http
GET /wallet/credentials
```

Response:

```json
{
  "results": [
    {
      "attrs": {
        "Surname": "Alice",
        "Age": "25",
        "Name": "Holder"
      },
      "cred_def_id": "BzDvB7StHDD1HQKczybHWC:3:CL:16:Demo_Person",
      "cred_rev_id": "1",
      "referent": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
      "rev_reg_id": "BzDvB7StHDD1HQKczybHWC:4:BzDvB7StHDD1HQKczybHWC:3:CL:16:Demo_Person:CL_ACCUM:73890f4d-42fd-42c5-9a2e-b39fe0358fc6",
      "schema_id": "Pp7wcmoHgeMb3td99E5Yo8:2:Person:0.1.0"
    }
  ]
}
```

Checking the revocation status of the credential

```http
GET /wallet/credentials/47b18eb8-35f1-4d89-865e-d8355bec77fe/revocation-status
```

Response:

```json
{
  "revoked": true
}
```

The credential is revoked

Let's try verifying the credential (We are omitting the large responses for some of these calls to keep this concise):

Verifier sends request with date/time (2024-05-07 9:00 AM) before the revocation:

```http
POST /verifier/send-request
```

Request body:

```json
{
  "protocol_version": "v2",
  "comment": "string",
  "trace": true,
  "type": "indy",
  "indy_proof_request": {
    "non_revoked": {
      "from": 0,
      "to": 1715065200
    },
    "requested_attributes": {
      "surname": { "name": "Surname" },
      "name": { "name": "Name" },
      "age": { "name": "Age" }
    },
    "requested_predicates": {}
  },
  "save_exchange_record": true,
  "connection_id": "cf45f341-57ad-42bc-b727-6f35e311e7e7"
}
```

Holder responds:

```http
POST /verifier/accept-request
```

Request body:

```json
{
  "proof_id": "v2-142c6cd8-a84c-441f-b099-2b39ed6d2099",
  "type": "indy",
  "indy_presentation_spec": {
    "requested_attributes": {
      "age": {
        "cred_id": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
        "revealed": true
      },
      "name": {
        "cred_id": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
        "revealed": true
      },
      "surname": {
        "cred_id": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
        "revealed": true
      }
    },
    "requested_predicates": {},
    "self_attested_attributes": {}
  },
  "save_exchange_record": true
}
```

Verifier checks their `proof` SSE events:

```json
{
  "wallet_id": "9a7adafe-3a09-499b-a171-6d39a426bf9e",
  "topic": "proofs",
  "origin": "tenant faber",
  "group_id": "GroupA",
  "payload": {
    "connection_id": "cf45f341-57ad-42bc-b727-6f35e311e7e7",
    "created_at": "2024-05-07T07:21:58.776430Z",
    "error_msg": null,
    "parent_thread_id": null,
    "presentation": null,
    "presentation_request": null,
    "proof_id": "v2-635d106c-7777-4368-bc57-d24f7f878343",
    "protocol_version": "v2",
    "role": "verifier",
    "state": "done",
    "thread_id": "b8c70d2b-fe36-4216-9d0a-7c30a6fceb5e",
    "updated_at": "2024-05-07T07:29:10.445048Z",
    "verified": true
  }
}
```

The holder's credential is valid `"verified": true`

### Verifying with date after revoked date

Now the verifier verifies with a date/time (2024-05-07 9:11 AM) after the revoke:

```http
POST /verifier/send-request
```

Request body:

```json
{
  "protocol_version": "v2",
  "comment": "string",
  "trace": true,
  "type": "indy",
  "indy_proof_request": {
    "non_revoked": {
      "from": 0,
      "to": 1715065860
    },
    "requested_attributes": {
      "surname": { "name": "Surname" },
      "name": { "name": "Name" },
      "age": { "name": "Age" }
    },
    "requested_predicates": {}
  },
  "save_exchange_record": true,
  "connection_id": "cf45f341-57ad-42bc-b727-6f35e311e7e7"
}
```

Holder Responds:

```http
POST /verifier/accept-request
```

Request body:

```json
{
  "proof_id": "v2-1894498a-579b-4dd9-9875-856c7f3f4381",
  "type": "indy",
  "indy_presentation_spec": {
    "requested_attributes": {
      "age": {
        "cred_id": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
        "revealed": true
      },
      "name": {
        "cred_id": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
        "revealed": true
      },
      "surname": {
        "cred_id": "47b18eb8-35f1-4d89-865e-d8355bec77fe",
        "revealed": true
      }
    },
    "requested_predicates": {},
    "self_attested_attributes": {}
  },
  "save_exchange_record": true
}
```

Verifier checks their SSE proof events:

```json
{
  "wallet_id": "9a7adafe-3a09-499b-a171-6d39a426bf9e",
  "topic": "proofs",
  "origin": "tenant faber",
  "group_id": "GroupA",
  "payload": {
    "connection_id": "cf45f341-57ad-42bc-b727-6f35e311e7e7",
    "created_at": "2024-05-07T08:02:41.229378Z",
    "error_msg": null,
    "parent_thread_id": null,
    "presentation": null,
    "presentation_request": null,
    "proof_id": "v2-6aaf1b87-45aa-49ee-8e2e-24fe79663fa6",
    "protocol_version": "v2",
    "role": "verifier",
    "state": "done",
    "thread_id": "53fe75f8-f4b8-4e22-ae1a-b3a13f2f41c9",
    "updated_at": "2024-05-07T08:18:33.060039Z",
    "verified": false
  }
}
```

The verification failed `"verified": false`

Hooray you now know how to ensure credentials are not revoked when verifying credentials.
